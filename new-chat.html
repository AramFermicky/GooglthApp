<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ù–æ–≤—ã–π —á–∞—Ç</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="slide-in">
  <div class="mobile-frame android">
    <div class="app-container">
      <header class="app-header">
        <button class="chat-back-btn" id="back-btn">
          <svg viewBox="0 0 24 24" width="24" height="24">
            <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
        </button>
        <div class="app-title">–ù–æ–≤—ã–π —á–∞—Ç</div>
      </header>
      
      <div class="search-container" style="padding: 10px 16px;">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...">
          <div class="search-icon">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="contacts-section">
        <h2>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
        <div id="contacts-list" class="scrollable-list">
          <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>
    </div>
    
    <div class="android-navigation">
      <div class="navigation-button home"></div>
      <div class="navigation-button recent"></div>
      <div class="navigation-button back"></div>
    </div>
  </div>
  
  <!-- Firebase —á–µ—Ä–µ–∑ CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <!-- –ù–∞—à–∏ —Å–∫—Ä–∏–ø—Ç—ã -->
  <script src="firebase.js"></script>
  <script src="coreApp.js"></script>
  <script src="scripts.js"></script>
  
  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
      firebase.initialize()
        .then(() => {
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
          firebase.getAuth().onAuthStateChanged(user => {
            if (!user) {
              window.location.href = 'old_user.html';
              return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
            initContactSearch();
          });
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
          window.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        });
    });
    
    function initContactSearch() {
      const searchInput = document.getElementById('search-input');
      const contactsList = document.getElementById('contacts-list');
      const backBtn = document.getElementById('back-btn');
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥"
      backBtn.addEventListener('click', () => {
        window.navigateTo('app.html');
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
      searchInput.addEventListener('input', window.app.debounce((e) => {
        const query = e.target.value.trim();
        if (query.length >= 2) {
          searchContacts(query);
        } else {
          loadAllContacts();
        }
      }, 300));
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
      loadAllContacts();
    }
    
    function loadAllContacts() {
      const contactsList = document.getElementById('contacts-list');
      contactsList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...</div>';
      
      const userId = firebase.getAuth().currentUser.uid;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫—Ä–æ–º–µ —Å–µ–±—è
      firebase.getDatabase().ref('users').once('value', (snapshot) => {
        const usersData = snapshot.val();
        contactsList.innerHTML = '';
        
        if (!usersData) {
          contactsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üë•</div>
              <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>
            </div>
          `;
          return;
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º
        const users = Object.entries(usersData)
          .map(([id, user]) => ({ id, ...user }))
          .filter(user => user.id !== userId)
          .sort((a, b) => a.name.localeCompare(b.name));
        
        if (users.length === 0) {
          contactsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üë•</div>
              <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>
            </div>
          `;
          return;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        users.forEach(user => {
          const userElement = document.createElement('div');
          userElement.className = 'group-item';
          userElement.dataset.userId = user.id;
          
          userElement.innerHTML = `
            <div class="group-avatar">
              <svg viewBox="0 0 24 24" width="48" height="48" fill="#4285f4">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            </div>
            <div class="group-info">
              <div class="group-name">${user.name}</div>
              <div class="group-members">${user.status === 'online' ? '–û–Ω–ª–∞–π–Ω' : '–ù–µ –≤ —Å–µ—Ç–∏'}</div>
            </div>
          `;
          
          userElement.addEventListener('click', () => {
            // –°–æ–∑–¥–∞–µ–º ID —á–∞—Ç–∞
            const userIds = [firebase.getAuth().currentUser.uid, user.id].sort();
            const chatId = userIds.join('_');
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —á–∞—Ç—É
            window.navigateTo(`p2p-chat.html?chatId=${chatId}`);
          });
          
          contactsList.appendChild(userElement);
        });
      });
    }
    
    function searchContacts(query) {
      const contactsList = document.getElementById('contacts-list');
      contactsList.innerHTML = '<div class="loading">–ü–æ–∏—Å–∫...</div>';
      
      const userId = firebase.getAuth().currentUser.uid;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
      firebase.getDatabase().ref('users').once('value', (snapshot) => {
        const usersData = snapshot.val();
        contactsList.innerHTML = '';
        
        if (!usersData) {
          contactsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üë•</div>
              <p>–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å—É</p>
            </div>
          `;
          return;
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º
        const users = Object.entries(usersData)
          .map(([id, user]) => ({ id, ...user }))
          .filter(user => 
            user.id !== userId && 
            user.name.toLowerCase().includes(query.toLowerCase())
          )
          .sort((a, b) => a.name.localeCompare(b.name));
        
        if (users.length === 0) {
          contactsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üîç</div>
              <p>–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å—É</p>
            </div>
          `;
          return;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        users.forEach(user => {
          const userElement = document.createElement('div');
          userElement.className = 'group-item';
          userElement.dataset.userId = user.id;
          
          userElement.innerHTML = `
            <div class="group-avatar">
              <svg viewBox="0 0 24 24" width="48" height="48" fill="#4285f4">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            </div>
            <div class="group-info">
              <div class="group-name">${user.name}</div>
              <div class="group-members">${user.status === 'online' ? '–û–Ω–ª–∞–π–Ω' : '–ù–µ –≤ —Å–µ—Ç–∏'}</div>
            </div>
          `;
          
          userElement.addEventListener('click', () => {
            // –°–æ–∑–¥–∞–µ–º ID —á–∞—Ç–∞
            const userIds = [firebase.getAuth().currentUser.uid, user.id].sort();
            const chatId = userIds.join('_');
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —á–∞—Ç—É
            window.navigateTo(`p2p-chat.html?chatId=${chatId}`);
          });
          
          contactsList.appendChild(userElement);
        });
      });
    }
  </script>
</body>
</html>