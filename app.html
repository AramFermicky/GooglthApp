<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>GooglethApp</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="slide-in">
  <div class="mobile-frame android">
    <div class="app-container">
      <header class="app-header">
        <div class="app-title">
          <span class="G">G</span>
          <span class="o">o</span>
          <span class="o">o</span>
          <span class="g">g</span>
          <span class="l">l</span>
          <span class="t">t</span>
          <span class="h">h</span>
          <span class="A">A</span>
          <span class="p">p</span>
          <span class="p">p</span>
        </div>
        <button class="menu-btn" id="menuBtn">☰</button>
      </header>
      
      <div class="action-buttons">
        <div class="action-btn" id="create-group-btn">
          <div class="action-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M17 20.5C17 18.57 13.97 17 10 17S3 18.57 3 20.5V22H5V20.5C5 17.83 7.67 15.5 11 15.5C8.78 15.5 7 17.28 7 19.5H9.5L12 16.5L14.5 19.5H17C17 17.28 15.22 15.5 13 15.5C8.67 15.5 5 17.83 5 20.5V22H7V20.5Z"/>
            </svg>
          </div>
          <span>Создать группу</span>
        </div>
        <div class="action-btn" id="find-contacts-btn">
          <div class="action-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-5-9h10v2H7z"/>
            </svg>
          </div>
          <span>Найти контакты</span>
        </div>
        <div class="action-btn" id="new-chat-btn">
          <div class="action-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM10 17l5.5-5.5-1.4-1.42-4 4zm7.5-9.5l-1-1h-5v5h5V8z"/>
            </svg>
          </div>
          <span>Новый чат</span>
        </div>
      </div>
      
      <div class="groups-section">
        <h2>Ваши группы</h2>
        <div id="groups-list" class="scrollable-list">
          <!-- Группы будут загружены через JavaScript -->
        </div>
      </div>
      
      <div class="online-users-section">
        <h2>Онлайн</h2>
        <div id="online-users" class="scrollable-list">
          <!-- Онлайн-пользователи будут загружены через JavaScript -->
        </div>
      </div>
      
      <!-- Боковое меню -->
      <div class="menu-overlay" id="menuOverlay"></div>
      <div class="menu-panel" id="menuPanel">
        <div class="menu-header">
          <div class="menu-avatar pulse">
            <svg viewBox="0 0 24 24" width="40" height="40" fill="white">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </div>
          <div>
            <div class="menu-title">GooglethApp Аккаунт</div>
            <div class="menu-email">googlethapp@gmail.com</div>
          </div>
        </div>
        
        <div class="menu-section">
          <h3>Аккаунт</h3>
          <div class="menu-item" id="profile-menu-item">
            <div class="menu-icon">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            </div>
            <span>Профиль</span>
          </div>
          <div class="menu-item" id="devices-menu-item">
            <div class="menu-icon">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1H7c-.56 0-1-.44-1-1s.44-1 1-1h10zm2-7h-1V9c0-2.76-2.24-5-5-5s-5 2.24-5 5v2H6c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-9c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
              </svg>
            </div>
            <span>Устройства</span>
          </div>
          <div class="menu-item" id="google-account-menu-item">
            <div class="menu-icon">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2v-2zm0 4h2v6h-2v-6z"/>
              </svg>
            </div>
            <span>Google Account</span>
          </div>
        </div>
        
        <div class="menu-section">
          <h3>Фон чата</h3>
          <div class="backgrounds">
            <div class="background-option bg1 active"></div>
            <div class="background-option bg2"></div>
            <div class="background-option bg3"></div>
            <div class="background-option bg4"></div>
          </div>
        </div>
        
        <div class="menu-section">
          <h3>Темы</h3>
          <div class="themes">
            <div class="theme-option theme-light active"></div>
            <div class="theme-option theme-dark"></div>
            <div class="theme-option theme-blue"></div>
          </div>
        </div>
        
        <div class="menu-section">
          <div class="menu-item danger" id="logout-menu-item">
            <div class="menu-icon">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M11 15H6V4h5v11zm0 6H6v-5h5v5zm11-8H11v-2h11v2zm-7 4H11v-2h4v2zm8 4H11v-2h8v2z"/>
              </svg>
            </div>
            <span>Выйти из аккаунта</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="android-navigation">
      <div class="navigation-button home"></div>
      <div class="navigation-button recent"></div>
      <div class="navigation-button back"></div>
    </div>
  </div>
  
  <!-- Firebase через CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  
  <!-- Наши скрипты -->
  <script src="firebase.js"></script>
  <script src="coreApp.js"></script>
  <script src="scripts.js"></script>
  
  <script>
    // Инициализация приложения
    document.addEventListener('DOMContentLoaded', () => {
      // Инициализация Firebase
      firebase.initialize()
        .then(() => {
          // Проверка аутентификации
          firebase.getAuth().onAuthStateChanged(user => {
            if (!user) {
              window.location.href = 'old_user.html';
              return;
            }
            
            // Обновление информации о пользователе
            if (user.email) {
              document.querySelectorAll('.menu-email').forEach(el => {
                el.textContent = user.email;
              });
            }
            
            if (user.displayName) {
              document.querySelectorAll('.menu-title').forEach(el => {
                el.textContent = `${user.displayName} (GooglethApp)`;
              });
            }
            
            // Инициализация менеджера чатов
            chatManager.init().init();
            
            // Обработчики для главной страницы
            document.getElementById('create-group-btn').addEventListener('click', () => {
              window.navigateTo('create-group.html');
            });
            
            document.getElementById('find-contacts-btn').addEventListener('click', () => {
              window.navigateTo('find-contacts.html');
            });
            
            document.getElementById('new-chat-btn').addEventListener('click', () => {
              window.navigateTo('new-chat.html');
            });
            
            // Боковое меню
            const menuBtn = document.getElementById('menuBtn');
            const menuOverlay = document.getElementById('menuOverlay');
            const menuPanel = document.getElementById('menuPanel');
            
            menuBtn.addEventListener('click', () => {
              menuPanel.classList.add('active');
              menuOverlay.classList.add('active');
            });
            
            menuOverlay.addEventListener('click', () => {
              menuPanel.classList.remove('active');
              menuOverlay.classList.remove('active');
            });
            
            // Обработчики меню
            document.getElementById('profile-menu-item').addEventListener('click', () => {
              window.navigateTo('profile.html');
            });
            
            document.getElementById('devices-menu-item').addEventListener('click', () => {
              window.navigateTo('devices.html');
            });
            
            document.getElementById('google-account-menu-item').addEventListener('click', () => {
              window.navigateTo('google-account.html');
            });
            
            document.getElementById('logout-menu-item').addEventListener('click', async () => {
              try {
                await window.app.logoutUser();
                window.showSuccess('Вы успешно вышли из аккаунта');
                setTimeout(() => {
                  window.navigateTo('old_user.html');
                }, 1500);
              } catch (error) {
                window.showError('Ошибка выхода из системы: ' + error.message);
              }
            });
            
            // Обработчики для меню
            document.querySelectorAll('.background-option').forEach(option => {
              option.addEventListener('click', function() {
                // Удаление активного класса
                document.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('active'));
                
                // Добавление активного класса
                this.classList.add('active');
                
                // Сохранение фона в настройках
                const background = this.className.split(' ')[1];
                document.body.setAttribute('data-chat-background', background);
                
                // Сохранение в Firestore
                if (firebase.getAuth().currentUser) {
                  firebase.getFirestore().collection('users').doc(firebase.getAuth().currentUser.uid).update({
                    'settings.chatBackground': background
                  }).catch(error => {
                    console.error('Ошибка сохранения фона:', error);
                  });
                }
              });
            });
            
            document.querySelectorAll('.theme-option').forEach(option => {
              option.addEventListener('click', function() {
                // Удаление активного класса
                document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                
                // Добавление активного класса
                this.classList.add('active');
                
                // Установка темы
                const theme = this.className.split(' ')[1].split('-')[1];
                document.documentElement.setAttribute('data-theme', theme);
                
                // Сохранение в Firestore
                if (firebase.getAuth().currentUser) {
                  firebase.getFirestore().collection('users').doc(firebase.getAuth().currentUser.uid).update({
                    'settings.theme': theme
                  }).catch(error => {
                    console.error('Ошибка сохранения темы:', error);
                  });
                }
              });
            });
          });
        })
        .catch(error => {
          console.error('Ошибка инициализации Firebase:', error);
          window.showError('Не удалось подключиться к Firebase. Проверьте интернет-соединение.');
        });
    });
  </script>
</body>
</html>