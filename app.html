<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>GooglethApp</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="slide-in">
  <div class="mobile-frame android">
    <div class="app-container">
      <header class="app-header">
        <div class="app-title">
          <span class="G">G</span>
          <span class="o">o</span>
          <span class="o">o</span>
          <span class="g">g</span>
          <span class="l">l</span>
          <span class="t">t</span>
          <span class="h">h</span>
          <span class="A">A</span>
          <span class="p">p</span>
          <span class="p">p</span>
        </div>
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
      </header>
      
      <div class="action-buttons">
        <div class="action-btn" id="create-group-btn">
          <div class="action-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M17 20.5C17 18.57 13.97 17 10 17S3 18.57 3 20.5V22H5V20.5C5 17.83 7.67 15.5 11 15.5C8.78 15.5 7 17.28 7 19.5H9.5L12 16.5L14.5 19.5H17C17 17.28 15.22 15.5 13 15.5C8.67 15.5 5 17.83 5 20.5V22H7V20.5Z"/>
            </svg>
          </div>
          <span>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</span>
        </div>
        <div class="action-btn" id="find-contacts-btn">
          <div class="action-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-5-9h10v2H7z"/>
            </svg>
          </div>
          <span>–ù–∞–π—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</span>
        </div>
        <div class="action-btn" id="new-chat-btn">
          <div class="action-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM10 17l5.5-5.5-1.4-1.42-4 4zm7.5-9.5l-1-1h-5v5h5V8z"/>
            </svg>
          </div>
          <span>–ù–æ–≤—ã–π —á–∞—Ç</span>
        </div>
      </div>
      
      <div class="groups-section">
        <h2>–ù–µ–¥–∞–≤–Ω–∏–µ —á–∞—Ç—ã</h2>
        <div id="chats-list" class="scrollable-list">
          <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>
      
      <div class="online-users-section">
        <h2>–û–Ω–ª–∞–π–Ω</h2>
        <div id="online-users" class="scrollable-list">
          <!-- –û–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>
      
      <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
      <div class="menu-overlay" id="menuOverlay"></div>
      <div class="menu-panel" id="menuPanel">
        <div class="menu-header">
          <div class="menu-avatar pulse">
            <svg viewBox="0 0 24 24" width="40" height="40" fill="white">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </div>
          <div>
            <div class="menu-title">GooglethApp –ê–∫–∫–∞—É–Ω—Ç</div>
            <div class="menu-email">googlethapp@gmail.com</div>
          </div>
        </div>
        
        <div class="menu-section">
          <h3>–ê–∫–∫–∞—É–Ω—Ç</h3>
          <div class="menu-item" id="profile-menu-item">
            <div class="menu-icon">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            </div>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
          </div>
          <div class="menu-item" id="devices-menu-item">
            <div class="menu-icon">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1H7c-.56 0-1-.44-1-1s.44-1 1-1h10zm2-7h-1V9c0-2.76-2.24-5-5-5s-5 2.24-5 5v2H6c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-9c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
              </svg>
            </div>
            <span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span>
          </div>
          <div class="menu-item" id="google-account-menu-item">
            <div class="menu-icon">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2v-2zm0 4h2v6h-2v-6z"/>
              </svg>
            </div>
            <span>Google Account</span>
          </div>
        </div>
        
        <div class="menu-section">
          <h3>–§–æ–Ω —á–∞—Ç–∞</h3>
          <div class="backgrounds">
            <div class="background-option bg1 active"></div>
            <div class="background-option bg2"></div>
            <div class="background-option bg3"></div>
            <div class="background-option bg4"></div>
          </div>
        </div>
        
        <div class="menu-section">
          <h3>–¢–µ–º—ã</h3>
          <div class="themes">
            <div class="theme-option theme-light active"></div>
            <div class="theme-option theme-dark"></div>
            <div class="theme-option theme-blue"></div>
          </div>
        </div>
        
        <div class="menu-section">
          <div class="menu-item danger" id="logout-menu-item">
            <div class="menu-icon">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M11 15H6V4h5v11zm0 6H6v-5h5v5zm11-8H11v-2h11v2zm-7 4H11v-2h4v2zm8 4H11v-2h8v2z"/>
              </svg>
            </div>
            <span>–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="android-navigation">
      <div class="navigation-button home"></div>
      <div class="navigation-button recent"></div>
      <div class="navigation-button back"></div>
    </div>
  </div>
  
  <!-- Firebase —á–µ—Ä–µ–∑ CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <!-- –ù–∞—à–∏ —Å–∫—Ä–∏–ø—Ç—ã -->
  <script src="firebase.js"></script>
  <script src="coreApp.js"></script>
  <script src="scripts.js"></script>
  
  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
      firebase.initialize()
        .then(() => {
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
          firebase.getAuth().onAuthStateChanged(user => {
            if (!user) {
              window.location.href = 'old_user.html';
              return;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            if (user.email) {
              document.querySelectorAll('.menu-email').forEach(el => {
                el.textContent = user.email;
              });
            }
            
            if (user.displayName) {
              document.querySelectorAll('.menu-title').forEach(el => {
                el.textContent = `${user.displayName} (GooglethApp)`;
              });
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —á–∞—Ç–æ–≤
            initChatManager();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.getElementById('create-group-btn').addEventListener('click', () => {
              window.navigateTo('create-group.html');
            });
            
            document.getElementById('find-contacts-btn').addEventListener('click', () => {
              window.navigateTo('find-contacts.html');
            });
            
            document.getElementById('new-chat-btn').addEventListener('click', () => {
              window.navigateTo('new-chat.html');
            });
            
            // –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
            const menuBtn = document.getElementById('menuBtn');
            const menuOverlay = document.getElementById('menuOverlay');
            const menuPanel = document.getElementById('menuPanel');
            
            menuBtn.addEventListener('click', () => {
              menuPanel.classList.add('active');
              menuOverlay.classList.add('active');
            });
            
            menuOverlay.addEventListener('click', () => {
              menuPanel.classList.remove('active');
              menuOverlay.classList.remove('active');
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–µ–Ω—é
            document.getElementById('profile-menu-item').addEventListener('click', () => {
              window.navigateTo('profile.html');
            });
            
            document.getElementById('devices-menu-item').addEventListener('click', () => {
              window.navigateTo('devices.html');
            });
            
            document.getElementById('google-account-menu-item').addEventListener('click', () => {
              window.navigateTo('google-account.html');
            });
            
            document.getElementById('logout-menu-item').addEventListener('click', async () => {
              try {
                await window.app.logoutUser();
                window.showSuccess('–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
                setTimeout(() => {
                  window.navigateTo('old_user.html');
                }, 1500);
              } catch (error) {
                window.showError('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã: ' + error.message);
              }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–µ–Ω—é
            document.querySelectorAll('.background-option').forEach(option => {
              option.addEventListener('click', function() {
                // –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
                document.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('active'));
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
                this.classList.add('active');
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
                const background = this.className.split(' ')[1];
                document.body.setAttribute('data-chat-background', background);
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Realtime Database
                if (firebase.getAuth().currentUser) {
                  firebase.getDatabase().ref('users/' + firebase.getAuth().currentUser.uid + '/settings/chatBackground')
                    .set(background)
                    .catch(error => {
                      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ–Ω–∞:', error);
                    });
                }
              });
            });
            
            document.querySelectorAll('.theme-option').forEach(option => {
              option.addEventListener('click', function() {
                // –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
                document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
                this.classList.add('active');
                
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º—ã
                const theme = this.className.split(' ')[1].split('-')[1];
                document.documentElement.setAttribute('data-theme', theme);
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Realtime Database
                if (firebase.getAuth().currentUser) {
                  firebase.getDatabase().ref('users/' + firebase.getAuth().currentUser.uid + '/settings/theme')
                    .set(theme)
                    .catch(error => {
                      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã:', error);
                    });
                }
              });
            });
          });
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
          window.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        });
    });
    
    function initChatManager() {
      const userId = firebase.getAuth().currentUser.uid;
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–¥–∞–≤–Ω–∏—Ö —á–∞—Ç–æ–≤
      loadRecentChats(userId);
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      loadOnlineUsers();
    }
    
    function loadRecentChats(userId) {
      const chatsList = document.getElementById('chats-list');
      chatsList.innerHTML = '';
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      firebase.getDatabase().ref('users/' + userId + '/chats').on('value', (snapshot) => {
        const chatsData = snapshot.val();
        
        if (!chatsData || Object.keys(chatsData).length === 0) {
          chatsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üí¨</div>
              <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</p>
              <button class="primary-btn" onclick="window.navigateTo('new-chat.html')">–ù–æ–≤—ã–π —á–∞—Ç</button>
            </div>
          `;
          return;
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        const chats = Object.entries(chatsData)
          .map(([chatId, chat]) => ({ id: chatId, ...chat }))
          .sort((a, b) => b.lastMessageTime - a.lastMessageTime);
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —á–∞—Ç—ã
        chats.forEach(chat => {
          const chatElement = document.createElement('div');
          chatElement.className = 'chat-item';
          chatElement.dataset.chatId = chat.id;
          
          // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ
          const otherUserId = chat.id.split('_').find(id => id !== firebase.getAuth().currentUser.uid);
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ
          firebase.getDatabase().ref('users/' + otherUserId).once('value', (snapshot) => {
            const userData = snapshot.val();
            const lastMessage = chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            
            chatElement.innerHTML = `
              <div class="chat-avatar">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="#4285f4">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
              </div>
              <div class="chat-info">
                <div class="chat-name">${userData ? userData.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                <div class="chat-status">${lastMessage}</div>
              </div>
            `;
            
            chatElement.addEventListener('click', () => {
              window.navigateTo(`p2p-chat.html?chatId=${chat.id}`);
            });
            
            chatsList.appendChild(chatElement);
          });
        });
      });
    }
    
    function loadOnlineUsers() {
      const onlineUsersList = document.getElementById('online-users');
      onlineUsersList.innerHTML = '';
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      firebase.getDatabase().ref('users').orderByChild('status').equalTo('online').on('value', (snapshot) => {
        const usersData = snapshot.val();
        
        if (!usersData || Object.keys(usersData).length === 0) {
          onlineUsersList.innerHTML = `
            <div class="no-online-users">
              <div class="empty-icon">üë•</div>
              <p>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</p>
            </div>
          `;
          return;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        Object.entries(usersData).forEach(([userId, userData]) => {
          // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          if (userId === firebase.getAuth().currentUser.uid) return;
          
          const userElement = document.createElement('div');
          userElement.className = 'online-user';
          userElement.dataset.userId = userId;
          
          userElement.innerHTML = `
            <div class="online-avatar">
              <svg viewBox="0 0 24 24" width="48" height="48" fill="#4285f4">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
              <div class="online-status"></div>
            </div>
            <div class="online-info">
              <div class="online-name">${userData.name}</div>
              <div class="online-status-text">–û–Ω–ª–∞–π–Ω</div>
            </div>
          `;
          
          userElement.addEventListener('click', () => {
            // –°–æ–∑–¥–∞–µ–º ID —á–∞—Ç–∞
            const userIds = [firebase.getAuth().currentUser.uid, userId].sort();
            const chatId = userIds.join('_');
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —á–∞—Ç—É
            window.navigateTo(`p2p-chat.html?chatId=${chatId}`);
          });
          
          onlineUsersList.appendChild(userElement);
        });
      });
    }
  </script>
</body>
</html>