<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Чат</title>
  <link rel="stylesheet" href="styles.css">
  
  <!-- Firebase через CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="slide-in">
  <div class="mobile-frame android">
    <div class="chat-container">
      <div class="chat-header">
        <button class="chat-back-btn" id="back-btn">
          <svg viewBox="0 0 24 24" width="24" height="24">
            <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
        </button>
        <div class="chat-avatar">
          <svg viewBox="0 0 24 24" width="40" height="40" fill="#4285f4">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
        </div>
        <div class="chat-info">
          <div class="chat-name" id="chat-name">Иван Иванов</div>
          <div class="chat-status" id="chat-status">Онлайн</div>
        </div>
      </div>
      
      <div class="chat-messages" id="chat-messages">
        <div class="system-message">Вы начали чат с Иваном</div>
        <div class="message other">
          <div class="message-text">Привет! Как дела?</div>
          <div class="message-time">12:30</div>
        </div>
        <div class="message self">
          <div class="message-text">Все отлично, спасибо!</div>
          <div class="message-time">12:31</div>
        </div>
      </div>
      
      <div class="chat-input">
        <input type="text" id="message-input" placeholder="Сообщение...">
        <button id="send-btn">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="android-navigation">
      <div class="navigation-button home"></div>
      <div class="navigation-button recent"></div>
      <div class="navigation-button back"></div>
    </div>
  </div>
  
  <!-- Наши скрипты -->
  <script src="firebase.js"></script>
  <script src="coreApp.js"></script>
  <script src="scripts.js"></script>
  
  <script>
    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', () => {
      // Инициализация Firebase
      firebase.initialize()
        .then(() => {
          // Проверка аутентификации
          firebase.getAuth().onAuthStateChanged(user => {
            if (!user) {
              window.location.href = 'old_user.html';
              return;
            }
            
            // Инициализация чата
            initChat();
          });
        })
        .catch(error => {
          console.error('Ошибка инициализации Firebase:', error);
          window.showError('Не удалось подключиться к Firebase. Проверьте интернет-соединение.');
        });
    });
    
    function initChat() {
      const chatMessages = document.getElementById('chat-messages');
      const messageInput = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      const backBtn = document.getElementById('back-btn');
      
      // Получаем ID чата из URL (например, ?chatId=uid1_uid2)
      const urlParams = new URLSearchParams(window.location.search);
      const chatId = urlParams.get('chatId');
      
      if (!chatId) {
        window.showError('Неверный ID чата');
        setTimeout(() => {
          window.navigateTo('app.html');
        }, 1500);
        return;
      }
      
      // Определяем ID собеседника
      const userId = firebase.getAuth().currentUser.uid;
      const otherUserId = chatId.split('_').find(id => id !== userId);
      
      // Загружаем информацию о собеседнике
      loadUserInfo(otherUserId);
      
      // Загружаем сообщения
      loadMessages(chatId);
      
      // Обработчик отправки сообщения
      sendBtn.addEventListener('click', () => {
        sendMessage(chatId, messageInput.value.trim());
      });
      
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage(chatId, messageInput.value.trim());
        }
      });
      
      // Обработчик кнопки "назад"
      backBtn.addEventListener('click', () => {
        window.navigateTo('app.html');
      });
    }
    
    function loadUserInfo(userId) {
      const chatName = document.getElementById('chat-name');
      const chatStatus = document.getElementById('chat-status');
      
      firebase.getDatabase().ref('users/' + userId).on('value', (snapshot) => {
        const userData = snapshot.val();
        
        if (userData) {
          chatName.textContent = userData.name || 'Пользователь';
          
          if (userData.status === 'online') {
            chatStatus.textContent = 'Онлайн';
            chatStatus.style.color = '#34a853';
          } else {
            const lastSeen = userData.lastSeen ? new Date(userData.lastSeen) : null;
            if (lastSeen) {
              chatStatus.textContent = `Был в сети ${formatTimeAgo(lastSeen)}`;
            } else {
              chatStatus.textContent = 'Не в сети';
            }
            chatStatus.style.color = '#5f6368';
          }
        }
      });
    }
    
    function loadMessages(chatId) {
      const chatMessages = document.getElementById('chat-messages');
      const userId = firebase.getAuth().currentUser.uid;
      
      firebase.getDatabase().ref('messages/' + chatId).on('child_added', (snapshot) => {
        const message = snapshot.val();
        const messageId = snapshot.key;
        
        if (message && message.text) {
          const isSelf = message.sender === userId;
          const messageElement = createMessageElement(message, isSelf, messageId);
          chatMessages.appendChild(messageElement);
          
          // Прокрутка вниз
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      });
    }
    
    function createMessageElement(message, isSelf, messageId) {
      const messageElement = document.createElement('div');
      messageElement.className = `message ${isSelf ? 'self' : 'other'}`;
      messageElement.dataset.messageId = messageId;
      
      const messageText = document.createElement('div');
      messageText.className = 'message-text';
      messageText.textContent = message.text;
      
      const messageTime = document.createElement('div');
      messageTime.className = 'message-time';
      messageTime.textContent = formatTime(new Date(message.timestamp));
      
      messageElement.appendChild(messageText);
      messageElement.appendChild(messageTime);
      
      return messageElement;
    }
    
    function sendMessage(chatId, text) {
      if (!text) return;
      
      const userId = firebase.getAuth().currentUser.uid;
      const timestamp = new Date().toISOString();
      
      // Создаем новое сообщение
      const newMessageRef = firebase.getDatabase().ref('messages/' + chatId).push();
      newMessageRef.set({
        text: text,
        sender: userId,
        timestamp: timestamp,
        read: false
      })
      .then(() => {
        // Очищаем поле ввода
        document.getElementById('message-input').value = '';
        
        // Прокрутка вниз
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      })
      .catch(error => {
        window.showError('Ошибка отправки сообщения: ' + error.message);
      });
    }
    
    function formatTime(date) {
      const now = new Date();
      const diff = now - date;
      
      // Если сегодня
      if (date.getDate() === now.getDate() && 
          date.getMonth() === now.getMonth() && 
          date.getFullYear() === now.getFullYear()) {
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }
      
      // Если вчера
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      if (date.getDate() === yesterday.getDate() && 
          date.getMonth() === yesterday.getMonth() && 
          date.getFullYear() === yesterday.getFullYear()) {
        return 'Вчера ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }
      
      // Иначе дата
      return date.toLocaleDateString([], {month: 'short', day: 'numeric'}) + 
             ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function formatTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (seconds < 60) {
        return 'только что';
      } else if (minutes < 60) {
        return `${minutes} мин. назад`;
      } else if (hours < 24) {
        return `${hours} ч. назад`;
      } else if (days < 7) {
        return `${days} дн. назад`;
      } else {
        return date.toLocaleDateString();
      }
    }
  </script>
</body>
</html>