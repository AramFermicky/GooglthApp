<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Вход в аккаунт</title>
  <link rel="stylesheet" href="auth-styles.css">
</head>
<body class="slide-in">
  <div class="mobile-frame android">
    <div class="auth-container">
      <div class="google-logo">
        <span class="G">G</span>
        <span class="o">o</span>
        <span class="o">o</span>
        <span class="g">g</span>
        <span class="l">l</span>
        <span class="t">t</span>
        <span class="h">h</span>
        <span class="A">A</span>
        <span class="p">p</span>
        <span class="p">p</span>
      </div>
      
      <div class="login-card scrollable-form">
        <h2>Вход в аккаунт</h2>
        
        <div class="form-group">
          <label>Имя пользователя или email</label>
          <input type="text" id="login-identifier" placeholder="example@gmail.com" onblur="checkEmailAvailability()">
          <div id="email-status" style="margin-top: 5px; font-size: 0.8rem; height: 16px;"></div>
        </div>
        
        <div class="form-group">
          <label>Пароль</label>
          <input type="password" id="login-password" placeholder="••••••••">
        </div>
        
        <button class="google-btn primary" id="login-btn">
          Войти
        </button>
        
        <div class="forgot-password">
          <a href="#" id="forgot-password-link">Забыли пароль?</a>
        </div>
        
        <div class="divider">
          <span>или</span>
        </div>
        
        <div class="google-buttons-container">
          <button class="email-btn" id="email-login">
            Войти через email
          </button>
          <button class="google-btn" id="google-login">
            <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right: 8px;">
              <path d="M22.56 12.25c0-.73-.06-1.43-.18-2.11H12v3.87h5.76c-.25 1.44-1.01 2.68-2.1 3.55v2.3h3.43c2.02-1.85 3.18-4.45 3.18-7.38z" fill="#4285F4"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.43-2.66c-.99.67-2.22 1.19-3.85 1.19-2.96 0-5.43-1.99-6.32-4.64H3.31v2.85C5.14 20.03 8.3 23 12 23z" fill="#34A853"/>
              <path d="M5.68 14.35c-.16-.48-.27-.99-.27-1.5 0-.52.11-1.02.27-1.5v-2.85H3.31C2.41 8.01 1.5 9.61 1.5 11.5 1.5 13.39 2.41 14.99 3.31 16.5l2.37-2.15z" fill="#FBBC05"/>
              <path d="M12 5.4c1.54 0 2.93.52 4.01 1.46l2.99-2.99C17.06 2.72 14.71 2 12 2 7.28 2 3.1 4.6 1.5 8.4l3.31 2.54c.9-2.83 3.54-4.94 6.19-4.94z" fill="#EA4335"/>
            </svg>
            Войти через Google
          </button>
        </div>
        
        <div class="auth-footer">
          <p>Нет аккаунта? <a href="new_user.html">Создать аккаунт</a></p>
        </div>
      </div>
      
      <div class="google-footer">
        <div class="footer-links">
          <a href="#">Политика конфиденциальности</a> • <a href="#">Условия использования</a>
        </div>
        <div class="language-selector">
          Русский ▼
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase через CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <!-- Наши скрипты -->
  <script src="firebase.js"></script>
  <script src="coreApp.js"></script>
  <script src="scripts.js"></script>
  
  <script>
    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', () => {
      // Инициализация Firebase
      firebase.initialize()
        .then(() => {
          // Проверка аутентификации
          firebase.getAuth().onAuthStateChanged(user => {
            if (user) {
              window.location.href = 'app.html';
            }
          });
          
          // Обработчик входа
          document.getElementById('login-btn').addEventListener('click', async () => {
            const identifier = document.getElementById('login-identifier').value;
            const password = document.getElementById('login-password').value;
            
            if (!identifier || !password) {
              window.showError('Пожалуйста, заполните все поля');
              return;
            }
            
            try {
              // Вход пользователя
              const userCredential = await firebase.getAuth().signInWithEmailAndPassword(identifier, password);
              const user = userCredential.user;
              
              // Обновление статуса пользователя в Realtime Database
              await firebase.getDatabase().ref('users/' + user.uid).update({
                status: 'online',
                lastSeen: new Date().toISOString()
              });
              
              window.showSuccess('Успешный вход! Добро пожаловать в GooglethApp');
              setTimeout(() => {
                window.navigateTo('app.html');
              }, 1000);
            } catch (error) {
              let message = 'Ошибка входа. Пожалуйста, проверьте email и пароль.';
              if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                message = 'Неверный email или пароль';
              } else if (error.code === 'auth/user-disabled') {
                message = 'Этот аккаунт был отключен. Обратитесь в поддержку.';
              } else if (error.code === 'auth/too-many-requests') {
                message = 'Слишком много попыток входа. Попробуйте позже.';
              }
              
              window.showError(message);
            }
          });
          
          // Обработчик входа через Google
          document.getElementById('google-login').addEventListener('click', async () => {
            try {
              const provider = new firebase.auth.GoogleAuthProvider();
              const result = await firebase.getAuth().signInWithPopup(provider);
              const user = result.user;
              
              // Проверка существования пользователя в Realtime Database
              const userSnapshot = await firebase.getDatabase().ref('users/' + user.uid).once('value');
              const userExists = userSnapshot.exists();
              
              if (!userExists) {
                // Создание документа пользователя, если его нет
                const userData = {
                  name: user.displayName,
                  email: user.email,
                  avatar: user.photoURL,
                  createdAt: new Date().toISOString(),
                  status: 'online',
                  lastSeen: new Date().toISOString(),
                  settings: {
                    theme: 'light',
                    chatBackground: 'bg1'
                  }
                };
                
                await firebase.getDatabase().ref('users/' + user.uid).set(userData);
              } else {
                // Обновление существующего документа
                await firebase.getDatabase().ref('users/' + user.uid).update({
                  name: user.displayName,
                  email: user.email,
                  avatar: user.photoURL,
                  status: 'online',
                  lastSeen: new Date().toISOString()
                });
              }
              
              window.showSuccess('Вход через Google успешен!');
              setTimeout(() => {
                window.navigateTo('app.html');
              }, 1500);
            } catch (error) {
              let message = 'Ошибка входа через Google. Пожалуйста, попробуйте еще раз.';
              if (error.code === 'auth/popup-closed-by-user') {
                message = 'Окно авторизации закрыто. Пожалуйста, попробуйте снова.';
              }
              
              window.showError(message);
            }
          });
          
          // Обработчик входа через email
          document.getElementById('email-login').addEventListener('click', () => {
            window.navigateTo('old_user.html');
          });
          
          // Обработчик забытого пароля
          document.getElementById('forgot-password-link').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const identifier = document.getElementById('login-identifier').value;
            if (!identifier) {
              window.showError('Пожалуйста, введите email');
              return;
            }
            
            try {
              await firebase.getAuth().sendPasswordResetEmail(identifier);
              window.showSuccess('Письмо для сброса пароля отправлено. Проверьте вашу почту.');
            } catch (error) {
              let message = 'Ошибка отправки письма. Пожалуйста, попробуйте еще раз.';
              if (error.code === 'auth/user-not-found') {
                message = 'Пользователь с таким email не найден.';
              }
              
              window.showError(message);
            }
          });
          
          // Проверка email
          document.getElementById('login-identifier').addEventListener('blur', async () => {
            const email = document.getElementById('login-identifier').value;
            const statusEl = document.getElementById('email-status');
            
            if (!email || !statusEl) return;
            
            try {
              const methods = await firebase.getAuth().fetchSignInMethodsForEmail(email);
              
              if (methods.length > 0) {
                statusEl.textContent = 'Аккаунт найден';
                statusEl.style.color = '#34a853';
              } else {
                statusEl.textContent = 'Email не найден';
                statusEl.style.color = '#ea4335';
              }
            } catch (error) {
              statusEl.textContent = 'Ошибка проверки';
              statusEl.style.color = '#ea4335';
            }
          });
        })
        .catch(error => {
          console.error('Ошибка инициализации Firebase:', error);
          document.body.innerHTML = `
            <div class="mobile-frame android">
              <div class="auth-container">
                <div class="google-logo">
                  <span class="G">G</span>
                  <span class="o">o</span>
                  <span class="o">o</span>
                  <span class="g">g</span>
                  <span class="l">l</span>
                  <span class="t">t</span>
                  <span class="h">h</span>
                  <span class="A">A</span>
                  <span class="p">p</span>
                  <span class="p">p</span>
                </div>
                
                <div class="login-card" style="text-align: center; padding: 30px;">
                  <h2>Ошибка инициализации</h2>
                  <p style="margin: 15px 0; color: #5f6368;">Не удалось подключиться к Firebase. Проверьте интернет-соединение.</p>
                  <button onclick="window.location.reload()" style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Попробовать снова
                  </button>
                </div>
              </div>
            </div>
          `;
        });
    });
  </script>
</body>
</html>